@page "/draft"

@inject Data.IFNFData FNFData
@inject Nhl.Api.INhlApi NhlApi

<MudPaper Class="pa-4 my-2">
    @if (filteredPlayers is not null)
    {
        <MudTextField @bind-Value="_searchString" Placeholder="Search players..." Adornment="Adornment.Start" Immediate="true" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" />
        
        <MudChipSet Class="my-4" T="string" @bind-SelectedValue="_selectedPositionFilter" SelectionMode="SelectionMode.SingleSelection">
            <MudChip Text="All" Color="Color.Primary" Variant="Variant.Text" Value=@("All")>All</MudChip>
            <MudChip Text="F" Color="Color.Primary" Variant="Variant.Text" Value=@("F")>F</MudChip>
            <MudChip Text="D" Color="Color.Primary" Variant="Variant.Text" Value=@("D")>D</MudChip>
            <MudChip Text="G" Color="Color.Primary" Variant="Variant.Text" Value=@("G")>G</MudChip>
        </MudChipSet>        
        
        <MudChipSet Class="my-4" T="string" @bind-SelectedValue="_selectedNationality" SelectionMode="SelectionMode.SingleSelection">
            <MudChip Color="Color.Primary" Variant="Variant.Text" Value=@("All")>üåç</MudChip>
            <MudChip Color="Color.Error" Variant="Variant.Text" Value=@("CAN")>üá®üá¶</MudChip>
            <MudChip Color="Color.Info" Variant="Variant.Text" Value=@("USA")>üá∫üá∏</MudChip>
            <MudChip Color="Color.Warning" Variant="Variant.Text" Value=@("SWE")>üá∏üá™</MudChip>
            <MudChip Color="Color.Surface" Variant="Variant.Text" Value=@("FIN")>üá´üáÆ</MudChip>
        </MudChipSet>
        
        @foreach (var player in filteredPlayers.OrderBy(x => !allAvailablePlayers.Contains(x)))
        {
            <MudStack Class="my-2" Row="true" AlignItems="AlignItems.Center">
                <MudButton OnClick="() => DraftPlayer(player)" Color="Color.Primary" Variant="Variant.Filled" Disabled=@(!allAvailablePlayers.Contains(player))>Draft</MudButton>
                
                <MudStack @onclick=@(() => RowClicked(player))>
                    <MudText><b>@($"{player.FirstName} {player.LastName}")</b></MudText>
                    <MudText Typo="Typo.body2">F - TBL (14)</MudText>
                </MudStack>
            </MudStack>
            
            <MudDivider />
        }
    }
</MudPaper>

@if (overlayPlayer is not null && overlayPlayerInfo is not null)
{
    <MudOverlay @bind-Visible="@_playerOverlayVisible" DarkBackground AutoClose>
        <MudPaper Class="py-4" Style="height: 70vh; width: 95vw;">
            <MudStack Class="px-4" Row="true" AlignItems="AlignItems.Center">
                <MudImage Src="@overlayPlayerInfo.Headshot" Width="150"/>
                
                <MudStack>
                    <MudText Typo="Typo.h6">@overlayPlayer.FirstName @overlayPlayer.LastName</MudText>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceAround">
                        
                        <MudStack AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.caption">GP</MudText>
                            <MudText Typo="Typo.h6"><b>@overlayPlayerInfo.SeasonTotals.Last().GamesPlayed</b></MudText>
                        </MudStack>                      
                        
                        <MudStack AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.caption">G</MudText>
                            <MudText Typo="Typo.h6"><b>@overlayPlayerInfo.SeasonTotals.Last().Goals</b></MudText>
                        </MudStack>                        
                        
                        <MudStack AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.caption">A</MudText>
                            <MudText Typo="Typo.h6"><b>@overlayPlayerInfo.SeasonTotals.Last().Assists</b></MudText>
                        </MudStack>

                        <MudStack AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.caption">P</MudText>
                            <MudText Typo="Typo.h6"><b>@overlayPlayerInfo.SeasonTotals.Last().Points</b></MudText>
                        </MudStack>

                    </MudStack>
                </MudStack>
            </MudStack>
            <MudPaper Class="my-n2 relative">
                <br/>
                <br/>
                <br/>
                <br/>
                more player info
            </MudPaper>
        </MudPaper>
    </MudOverlay>
}

@code {
    private IEnumerable<Data.FNFPlayer> allPlayers;
    private IEnumerable<Data.FNFPlayer> allAvailablePlayers;
    private IEnumerable<Data.FNFPlayer> filteredPlayers;

    private bool _playerOverlayVisible
    {
        get => playerOverlayVisible;
        set
        {
            playerOverlayVisible = value;
            if (!playerOverlayVisible)
            {
                overlayPlayer = null;
                overlayPlayerInfo = null;
            }
        }
    }
    private bool playerOverlayVisible = false;
    private Data.FNFPlayer? overlayPlayer;
    private Nhl.Api.Models.Player.PlayerProfile? overlayPlayerInfo;

    private string _selectedNationality
    {
        get => selectedNationality;
        set
        {
            selectedNationality = value;
            ApplyFilters();
        }
    }
    private string selectedNationality = "All";
    
    private string _selectedPositionFilter
    {
        get => selectedPositionFilter;
        set
        {
            selectedPositionFilter = value;
            ApplyFilters();
        }
    }
    private string selectedPositionFilter = "All";
    
    private string searchString;
    private string _searchString
    {
        get => searchString;
        set
        {
            searchString = value;
            ApplyFilters();
        }
    }
    
    protected override async Task OnInitializedAsync()
    {
        allPlayers = await FNFData.GetAllPlayersAsync();
        filteredPlayers = allPlayers;
        
        allAvailablePlayers = await FNFData.GetDraftAvailablePlayersAsync();
    }

    private async Task DraftPlayer(Data.FNFPlayer player)
    {
        // TODO
    }

    private async Task RowClicked(Data.FNFPlayer player)
    {
        playerOverlayVisible = true;
        overlayPlayer = player;
        overlayPlayerInfo = await NhlApi.GetPlayerInformationAsync(player.NhlIdInt);
    }

    private Func<Data.FNFPlayer, bool> quickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;

        if (x.FirstName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (x.LastName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        return false;
    };

    private void ApplyFilters()
    {
        filteredPlayers = allPlayers;
        
        if (selectedPositionFilter != "All")
        {
            filteredPlayers = filteredPlayers.Where(p => p.Position == selectedPositionFilter);
        }
        
        if (selectedNationality != "All")
        {
            filteredPlayers = filteredPlayers.Where(p => p.Nationality == selectedNationality);
        }
        
        filteredPlayers = filteredPlayers.Where(quickFilter);
    }
}